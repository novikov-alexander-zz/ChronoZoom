var CZ;(function(n){(function(t){function i(){$.widget("ui.virtualCanvas",{_layersContent:undefined,_layers:[],_create:function(){var t=this,r,i;t.element.addClass("virtualCanvas");r=t._getClientSize();this.lastEvent=null;this.canvasWidth=null;this.canvasHeight=null;this.requestNewFrame=!1;t.cursorPositionChangedEvent=new $.Event("cursorPositionChanged");t.breadCrumbsChangedEvent=$.Event("breadCrumbsChanged");t.innerZoomConstraintChangedEvent=$.Event("innerZoomConstraintChanged");t.currentlyHoveredInfodot=undefined;t.breadCrumbs=[];t.recentBreadCrumb={vcElement:{title:"initObject"}};t.cursorPosition=0;this.topCloak=$(".root-cloak-top");this.rightCloak=$(".root-cloak-right");this.bottomCloak=$(".root-cloak-bottom");this.leftCloak=$(".root-cloak-left");this.showCloak=!1;i=t.element.children("div");i.each(function(n){$(this).addClass("virtualCanvasLayerDiv unselectable").zIndex(n*3);var i=$("<canvas><\/canvas>").appendTo($(this)).addClass("virtualCanvasLayerCanvas").zIndex(n*3+1);t._layers.push($(this))});this._layersContent=new n.VCContent.CanvasRootElement(t,undefined,"__root__",-Infinity,-Infinity,Infinity,Infinity);this.options.visible=new n.Viewport.VisibleRegion2d(0,0,1);this.updateViewport();t.element.bind("mousemove."+this.widgetName,function(n){t.mouseMove(n)});t.element.bind("mousedown."+this.widgetName,function(n){switch(n.which){case 1:t._mouseDown(n)}});t.element.bind("mouseup."+this.widgetName,function(n){switch(n.which){case 1:t._mouseUp(n)}});t.element.bind("mouseleave."+this.widgetName,function(n){t._mouseLeave(n)})},destroy:function(){this._destroy()},_mouseDown:function(t){var i=n.Common.getXBrowserMouseOrigin(this.element,t);this.lastClickPosition={x:i.x,y:i.y};$("iframe").css("pointer-events","none");$("#iframe_layer").css("display","block").css("z-index","99999")},_mouseUp:function(t){var r=this.getViewport(),i=n.Common.getXBrowserMouseOrigin(this.element,t),u=r.pointScreenToVirtual(i.x,i.y);this.lastClickPosition&&this.lastClickPosition.x==i.x&&this.lastClickPosition.y==i.y&&this._mouseClick(t);$("iframe").css("pointer-events","auto");$("#iframe_layer").css("display","none")},_mouseLeave:function(t){if(this.currentlyHoveredContentItem!=null&&this.currentlyHoveredContentItem.onmouseleave!=null)this.currentlyHoveredContentItem.onmouseleave(t);if(this.currentlyHoveredInfodot!=null&&this.currentlyHoveredInfodot.onmouseleave!=null)this.currentlyHoveredInfodot.onmouseleave(t);if(this.currentlyHoveredTimeline!=null&&this.currentlyHoveredTimeline.onmouseunhover!=null)this.currentlyHoveredTimeline.onmouseunhover(null,t);n.Common.stopAnimationTooltip();this.lastEvent=null},_mouseClick:function(t){var f=this.getViewport(),i=n.Common.getXBrowserMouseOrigin(this.element,t),r=f.pointScreenToVirtual(i.x,i.y),u=function(n,i){var o=n.isInside(i),f,e;if(!o)return!1;for(f=0;f<n.children.length;f++)if(e=n.children[f],u(e,r))return!0;return n.reactsOnMouse&&n.onmouseclick?n.onmouseclick(i,t):!1};u(this._layersContent,r)},getHoveredTimeline:function(){return this.currentlyHoveredTimeline},getHoveredInfodot:function(){return this.currentlyHoveredInfodot},getCursorPosition:function(){return this.cursorPosition},_setConstraintsByInfodotHover:function(t){var i,r;t?(r=this.getViewport(),i=t.outerRad*n.Settings.infoDotZoomConstraint/r.width):i=undefined;this.RaiseInnerZoomConstraintChanged(i)},RaiseInnerZoomConstraintChanged:function(n){this.innerZoomConstraintChangedEvent.zoomValue=n;this.element.trigger(this.innerZoomConstraintChangedEvent)},RaiseCursorChanged:function(){this.cursorPositionChangedEvent.Time=this.cursorPosition;this.element.trigger(this.cursorPositionChangedEvent)},updateTooltipPosition:function(t){var r=this.viewport.pointVirtualToScreen(t.x,t.y),u=17,f,e,i=null;(n.Common.tooltipMode=="infodot"?i=this.currentlyHoveredInfodot:n.Common.tooltipMode=="timeline"&&(i=this.currentlyHoveredTimeline),i!=null)&&(f=parseInt(r.x)+i.panelWidth,e=parseInt(r.y)+i.panelHeight+u,f>this.canvasWidth&&(r.x=this.canvasWidth-i.panelWidth),e>this.canvasHeight&&(r.y=this.canvasHeight-i.panelHeight-u+1),$(".bubbleInfo").css({position:"absolute",top:r.y,left:r.x}))},mouseMove:function(t){var s=this.getViewport(),o=n.Common.getXBrowserMouseOrigin(this.element,t),r=s.pointScreenToVirtual(o.x,o.y),i,e,u,f;if(this.currentlyHoveredInfodot||(this.cursorPosition=r.x,this.RaiseCursorChanged()),this.currentlyHoveredTimeline||(this.cursorPosition=r.x,this.RaiseCursorChanged()),i=[],e=function(n,r,u){var f,o,s;if(r){if(n.reactsOnMouse&&n.isMouseIn&&n.onmouseleave){n.onmouseleave(u,t);n.isMouseIn=!1}}else{if(f=n.isInside(u),r=!f,n.reactsOnMouse)if(f){if(n.isMouseIn){if(n.onmousemove)n.onmousemove(u,t);n.onmousehover&&i.push(n)}else if(n.isMouseIn=!0,n.onmouseenter)n.onmouseenter(u,t)}else if(n.isMouseIn){if(n.isMouseIn=!1,n.onmouseleave)n.onmouseleave(u,t)}else if(n.onmousemove)n.onmousemove(u,t);n.isMouseIn=f}for(o=0;o<n.children.length;o++)s=n.children[o],(!r||s.isMouseIn)&&e(s,r,u)},e(this._layersContent,!1,r),i.length==0&&this.hovered&&this.hovered.onmouseunhover){this.hovered.onmouseunhover(r,t);this.hovered=null}for(u=i.length;--u>=0;)if(i[u].onmousehover){i[u].onmousehover(r,t);if(this.hovered&&this.hovered!=i[u]&&this.hovered.onmouseunhover&&(!this.currentlyHoveredInfodot||this.currentlyHoveredInfodot&&this.currentlyHoveredInfodot.parent&&this.currentlyHoveredInfodot.parent!=this.hovered))this.hovered.onmouseunhover(r,t);this.hovered=this.currentlyHoveredContentItem?this.currentlyHoveredContentItem:i[u];break}(this.currentlyHoveredInfodot!=null&&this.currentlyHoveredInfodot.tooltipEnabled==!0||this.currentlyHoveredTimeline!=null&&this.currentlyHoveredTimeline.tooltipEnabled==!0&&n.Common.tooltipMode!="infodot")&&(f=null,n.Common.tooltipMode=="infodot"?f=this.currentlyHoveredInfodot:n.Common.tooltipMode=="timeline"&&(f=this.currentlyHoveredTimeline),f!=null&&f.tooltipIsShown==!1&&(f.tooltipIsShown=!0,n.Common.animationTooltipRunning=$(".bubbleInfo").fadeIn()),this.updateTooltipPosition(r));this.lastEvent=t},getLastEvent:function(){return this.lastEvent},getLayerContent:function(){return this._layersContent},findElement:function(n){var t=function(n,i){var f,r,u,e;if(n.id===i)return n;if(!n.children)return null;for(f=n.children.length,r=0;r<f;r++)if(u=n.children[r],u.id===i)return u;for(r=0;r<f;r++)if(u=n.children[r],e=t(u,i),e)return e;return null};return t(this._layersContent,n)},forEachElement:function(n){var t=function(n,i){var r,u,f;if(i(n),n.children)for(r=0;r<n.children.length;r++)u=n.children[r],f=t(u,i)};return t(this._layersContent,n)},_destroy:function(){return this.element.removeClass("virtualCanvas"),this.element.children(".virtualCanvasLayerDiv").each(function(){$(this).removeClass("virtualCanvasLayerDiv").removeClass("unselectable");$(this).remove(".virtualCanvasLayerCanvas")}),this.element.unbind("."+this.widgetName),this._layers=undefined,this._layersContent=undefined,this},_visibleToViewBox:function(n){var t=this.getViewport(),i=t.widthScreenToVirtual(t.width),r=t.heightScreenToVirtual(t.height),u=n.centerX-i/2,f=n.centerY-r/2;return{Left:u,Right:u+i,Top:f,Bottom:f+r}},setVisible:function(n,t){delete this.viewport;this.options.visible=n;this.isInAnimation=t&&t.isActive;var i=this._visibleToViewBox(n),r=this.getViewport();this._renderCanvas(this._layersContent,i,r)},updateViewport:function(){for(var u,i,t=this._getClientSize(),f=this._layers.length,r=0;r<f;r++)u=this._layers[r],u.width(t.width).height(t.height),i=u.children(".virtualCanvasLayerCanvas").first()[0],i&&(i.width=t.width,i.height=t.height);this.canvasWidth=n.Common.vc.width();this.canvasHeight=n.Common.vc.height();this.setVisible(this.options.visible)},_getClientSize:function(){return{width:this.element[0].clientWidth,height:this.element[0].clientHeight}},getViewport:function(){if(!this.viewport){var t=this._getClientSize(),i=this.options;this.viewport=new n.Viewport.Viewport2d(i.aspectRatio,t.width,t.height,i.visible)}return this.viewport},_renderCanvas:function(n,t,i){var f=this._layers.length,u,r,s;if(f!=0){for(u={},r=0;r<f;r++){var e=this._layers[r],h=e.children(".virtualCanvasLayerCanvas").first()[0],o=h.getContext("2d");o.clearRect(0,0,i.width,i.height);s=e[0].id;u[s]=o}n.render(u,t,i);this.updateCloakPosition(i)}},invalidate:function(){var n=this._visibleToViewBox(this.options.visible),t=this.getViewport();this._renderCanvas(this._layersContent,n,t)},breadCrumbsChanged:function(){this.breadCrumbsChangedEvent.breadCrumbs=this.breadCrumbs;this.element.trigger(this.breadCrumbsChangedEvent)},requestInvalidate:function(){var i,t;if(this.requestNewFrame=!1,n.Layout.animatingElements.length!=0)for(i in n.Layout.animatingElements)n.Layout.animatingElements[i].animation&&n.Layout.animatingElements[i].animation.isAnimating&&(n.Layout.animatingElements[i].calculateNewFrame(),this.requestNewFrame=!0);this.isInAnimation||(this.isInAnimation=!0,t=this,setTimeout(function(){t.isInAnimation=!1;t.invalidate();t.requestNewFrame&&t.requestInvalidate()},1e3/n.Settings.targetFps))},_findLca:function(n,t){for(var i=0;i<n.children.length;i++)if(n.children[i].type==="timeline"&&n.children[i].contains(t))return this._findLca(n.children[i],t);return n},findLca:function(n){var t=this._layersContent.children[0],i=1,r=t.x+i,u=t.x+t.width-i,f=t.y+i,e=t.y+t.height-i;return n.left=Math.max(r,Math.min(u,n.x)),n.right=Math.max(r,Math.min(u,n.x+n.width)),n.top=Math.max(f,Math.min(e,n.y)),n.bottom=Math.max(f,Math.min(e,n.y+n.height)),n.x=n.left,n.y=n.top,n.width=Math.max(0,n.right-n.left),n.height=Math.max(0,n.bottom-n.top),this._findLca(t,n)},_inBuffer:function(n,t,i){var u,r;if(n.intersects(t)&&n.isVisibleOnScreen(i)){if(n.isBuffered){for(u=!0,r=0;r<n.children.length;r++)n.children[r].type==="timeline"&&(u=u&&this._inBuffer(n.children[r],t,i));return u}return!1}return!0},inBuffer:function(n,t){var i=this._layersContent.children[0],r=i.x,u=i.x+i.width,f=i.y,e=i.y+i.height;return n.left=Math.max(r,Math.min(u,n.x)),n.right=Math.max(r,Math.min(u,n.x+n.width)),n.top=Math.max(f,Math.min(e,n.y)),n.bottom=Math.max(f,Math.min(e,n.y+n.height)),n.x=n.left,n.y=n.top,n.width=Math.max(0,n.right-n.left),n.height=Math.max(0,n.bottom-n.top),this._inBuffer(i,n,t)},options:{aspectRatio:1,visible:{centerX:0,centerY:0,scale:1}},cloakNonRootVirtualSpace:function(){this.showCloak=!0;var n=this.getViewport();this.updateCloakPosition(n);this.topCloak.addClass("visible");this.rightCloak.addClass("visible");this.bottomCloak.addClass("visible");this.leftCloak.addClass("visible")},showNonRootVirtualSpace:function(){this.showCloak=!1;this.topCloak.removeClass("visible");this.rightCloak.removeClass("visible");this.bottomCloak.removeClass("visible");this.leftCloak.removeClass("visible")},updateCloakPosition:function(n){if(this.showCloak){var t=this._layersContent.children[0],u=t.y,i=t.x+t.width,f=t.y+t.height,r=t.x;u=Math.max(0,n.pointVirtualToScreen(0,u).y);i=Math.max(0,n.pointVirtualToScreen(i,0).x);f=Math.max(0,n.pointVirtualToScreen(0,f).y);r=Math.max(0,n.pointVirtualToScreen(r,0).x);this.rightCloak.css("width",Math.max(0,n.width-i)+"px");this.leftCloak.css("width",r+"px");this.bottomCloak.css("height",Math.max(0,n.height-f)+"px");this.topCloak.css("height",u+"px");this.topCloak.css("left",r+"px");this.topCloak.css("right",Math.max(0,n.width-i)+"px");this.bottomCloak.css("left",r+"px");this.bottomCloak.css("right",Math.max(0,n.width-i)+"px")}}})}t.initialize=i})(n.VirtualCanvas||(n.VirtualCanvas={}));var t=n.VirtualCanvas})(CZ||(CZ={}));
//# sourceMappingURL=virtual-canvas.min.js.map
